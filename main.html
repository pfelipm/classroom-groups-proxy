<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // --- VARIABLES Y ELEMENTOS DEL DOM ---
  let currentLang;
  let userInfo = {};
  let currentTeachers = [];
  let infoModalInstance = null;
  const elements = {
    loader: document.getElementById('loader'),
    appContent: document.getElementById('app-content'),
    notificationArea: document.getElementById('notification-area'),
    langSwitcher: document.getElementById('lang-switcher'),
    courseSelect: document.getElementById('course-select'),
    exportCoursesBtn: document.getElementById('export-courses-btn'),
    usersSection: document.getElementById('users-section'),
    teachersList: document.getElementById('teachers-list'),
    studentsList: document.getElementById('students-list'),
    selectAllTeachers: document.getElementById('select-all-teachers'),
    selectAllStudents: document.getElementById('select-all-students'),
    exportUsersBtn: document.getElementById('export-users-btn'),
    groupCreationSection: document.getElementById('group-creation-section'),
    createGroupBtn: document.getElementById('create-group-btn'),
    makeGroupVisibleCheck: document.getElementById('make-group-visible-check'),
    makeTeachersManagersCheck: document.getElementById('make-teachers-managers-check'),
    restrictPostingCheck: document.getElementById('restrict-posting-check'),
    courseEmailsSection: document.getElementById('course-emails-section'),
    teacherGroupEmailSpan: document.getElementById('teacher-group-email'),
    courseGroupEmailSpan: document.getElementById('course-group-email'),
    copyTeacherEmailBtn: document.getElementById('copy-teacher-email-btn'),
    copyCourseEmailBtn: document.getElementById('copy-course-email-btn'),
    infoModal: document.getElementById('infoModal'),
    infoModalLabel: document.getElementById('infoModalLabel'),
    infoModalBody: document.getElementById('infoModalBody')
  };

  // --- DICCIONARIO DE TRADUCCIONES (i18n) ---
  const translations = {
    es: {
      appTitle: "Classroom Groups Proxy",
      madeBy: "Hecho con 游뽓 por",
      appDescription: "Esta aplicaci칩n te permite buscar tus clases de Classroom, ver sus participantes y crear grupos de Google con ellos de forma sencilla.",
      loading: "Cargando...",
      coursesSectionTitle: "1. Cursos de Classroom",
      selectCourseLabel: "Selecciona una clase",
      selectCourseDefault: "--- Por favor, selecciona una clase ---",
      exportCoursesBtn: "Exportar Lista de Cursos a CSV",
      courseEmailsSectionTitle: "Grupos Autom치ticos de Classroom",
      teacherGroupEmailLabel: "Email del grupo de profesorado",
      courseGroupEmailLabel: "Email del grupo de la clase (profesorado y alumnado)",
      copyBtnText: "Copiar al portapapeles",
      copySuccessText: "춰Copiado!",
      courseEmailsDescription: "Classroom crea autom치ticamente estas direcciones. 칔salas para compartir recursos en Drive o eventos de Calendar sin necesidad de crear un nuevo grupo.",
      usersSectionTitle: "2. Usuarios de la Clase Seleccionada",
      teachersListTitle: "Profesorado",
      studentsListTitle: "Alumnado",
      selectAll: "Seleccionar todos",
      exportUsersBtn: "Exportar Usuarios de esta Clase a CSV",
      groupCreationSectionTitle: "3. Crear Grupo de Google",
      groupCreationDescription: "Se crear치 un grupo con los usuarios seleccionados. El email del grupo se generar치 autom치ticamente.",
      createGroupBtn: "Crear Grupo",
      makeGroupVisibleLabel: "Hacer visible en Google Grupos (con archivo de conversaciones)",
      makeTeachersManagersLabel: "Hacer que el profesorado sea administrador del grupo",
      restrictPostingLabel: "Solo los propietarios y administradores podr치n enviar mensajes",
      errorTitle: "Error",
      warningTitle: "Aviso",
      successTitle: "칄xito",
      modalCloseBtn: "Cerrar",
      noCoursesFound: "No se encontraron clases en las que seas profesor.",
      courseFetchError: "Ocurri칩 un error al cargar tus clases.",
      userFetchError: "Ocurri칩 un error al cargar los usuarios de la clase.",
      userFetchFatalError: "Error fatal al obtener informaci칩n del usuario",
      groupCreateSuccess: "춰Grupo creado con 칠xito!",
      groupCreateError: "Ocurri칩 un error al crear el grupo.",
      groupExistsError: "El grupo con email {{groupEmail}} ya existe.",
      groupSettingsError: "El grupo se cre칩 con 칠xito, pero fall칩 la aplicaci칩n de los ajustes de configuraci칩n. Por favor, configura el grupo manualmente en Google Groups.",
      memberNotFoundError: "No se pudo crear el grupo porque uno de los miembros seleccionados no existe. Revisa la lista de participantes del curso en Classroom.",
      groupInsertPermissionError: "No se pudo crear el grupo. La cuenta que despleg칩 esta aplicaci칩n no tiene permisos de administrador para crear grupos en el dominio. Por favor, contacta con el administrador de TI de tu organizaci칩n.",
      exportError: "No hay datos para exportar.",
      // --- INICIO DE LA MODIFICACI칍N ---
      groupWithOnlyOwnerError: "Para que un grupo sea 칰til, debe tener al menos 3 miembros (t칰 y 2 m치s) 游뗶. Por favor, aseg칰rate de tener seleccionados al menos a dos participantes adem치s de ti.",
      // --- FIN DE LA MODIFICACI칍N ---
      ownerIsAddedNote: "Nota: El usuario que crea el grupo (t칰) ser치 a침adido siempre como propietario."
    },
    en: {
      appTitle: "Classroom Groups Proxy",
      madeBy: "Made with 游뽓 by",
      appDescription: "This application allows you to find your Classroom courses, see their participants, and easily create Google Groups with them.",
      loading: "Loading...",
      coursesSectionTitle: "1. Classroom Courses",
      selectCourseLabel: "Select a class",
      selectCourseDefault: "--- Please select a class ---",
      exportCoursesBtn: "Export Course List to CSV",
      courseEmailsSectionTitle: "Automatic Classroom Groups",
      teacherGroupEmailLabel: "Teachers group email",
      courseGroupEmailLabel: "Class group email (teachers and students)",
      copyBtnText: "Copy to clipboard",
      copySuccessText: "Copied!",
      courseEmailsDescription: "Classroom automatically creates these addresses. Use them to share resources in Drive or Calendar events without needing to create a new group.",
      usersSectionTitle: "2. Users from Selected Class",
      teachersListTitle: "Teachers",
      studentsListTitle: "Students",
      selectAll: "Select all",
      exportUsersBtn: "Export Users from this Class to CSV",
      groupCreationSectionTitle: "3. Create Google Group",
      groupCreationDescription: "A group will be created with the selected users. The group email will be generated automatically.",
      createGroupBtn: "Create Group",
      makeGroupVisibleLabel: "Make visible in Google Groups (with conversation archive)",
      makeTeachersManagersLabel: "Make teachers group managers",
      restrictPostingLabel: "Only owners and managers can post messages",
      errorTitle: "Error",
      warningTitle: "Warning",
      successTitle: "Success",
      modalCloseBtn: "Close",
      noCoursesFound: "No courses found where you are a teacher.",
      courseFetchError: "An error occurred while loading your courses.",
      userFetchError: "An error occurred while loading users for the class.",
      userFetchFatalError: "Fatal error while fetching user information",
      groupCreateSuccess: "Group created successfully!",
      groupCreateError: "An error occurred while creating the group.",
      groupExistsError: "The group with email {{groupEmail}} already exists.",
      groupSettingsError: "The group was created successfully, but applying the configuration settings failed. Please configure the group manually in Google Groups.",
      memberNotFoundError: "Could not create group because one of the selected members does not exist. Please check the participant list in the Classroom course.",
      groupInsertPermissionError: "Could not create group. The account that deployed this application does not have administrator permissions to create groups in the domain. Please contact your organization's IT administrator.",
      exportError: "There is no data to export.",
      // --- INICIO DE LA MODIFICACI칍N ---
      groupWithOnlyOwnerError: "For a group to be useful, it should have at least 3 members (you and 2 others) 游뗶. Please make sure you have at least two participants selected besides yourself.",
      // --- FIN DE LA MODIFICACI칍N ---
      ownerIsAddedNote: "Note: The user creating the group (you) will always be added as an owner."
    }
  };

  // --- FUNCIONES DE LA APLICACI칍N ---

  /** Muestra u oculta el spinner de carga */
  const showLoader = (show) => {
    elements.loader.style.display = show ? 'block' : 'none';
    elements.appContent.style.display = show ? 'none' : 'block';
  };
  
  const showModal = (title, message) => {
    if (!infoModalInstance) {
      infoModalInstance = new bootstrap.Modal(elements.infoModal);
    }
    elements.infoModalLabel.textContent = title;
    elements.infoModalBody.textContent = message;
    infoModalInstance.show();
  };

  const showNotification = (message, type = 'warning', emailToCopy = null) => {
    let title = '';
    let alertClass = '';
    let copyButtonId = '';

    switch(type) {
        case 'success':
            title = translations[currentLang].successTitle;
            alertClass = 'alert-success';
            break;
        case 'warning':
        case 'danger':
            title = (type === 'danger') ? translations[currentLang].errorTitle : translations[currentLang].warningTitle;
            alertClass = 'alert-warning';
            break;
        default:
            title = translations[currentLang].warningTitle;
            alertClass = 'alert-warning';
    }

    let content = `<strong>${title}:</strong> ${message}`;
    
    if (emailToCopy) {
      copyButtonId = `copy-btn-${Date.now()}`;
      content += `
        <div class="input-group mt-2">
          <span class="form-control bg-light" readonly>${emailToCopy}</span>
          <button class="btn btn-outline-secondary" type="button" id="${copyButtonId}" title="${translations[currentLang].copyBtnText}">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>`;
    }

    const alertHtml = `
      <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${content}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    
    elements.notificationArea.innerHTML = alertHtml;

    if (emailToCopy) {
        const newCopyButton = document.querySelector(`#${copyButtonId}`);
        if(newCopyButton) {
            newCopyButton.addEventListener('click', (e) => {
                copyToClipboard(emailToCopy, e.currentTarget);
            });
        }
    }
  };

  const setLanguage = (lang) => {
    elements.notificationArea.innerHTML = '';
    currentLang = lang;
    elements.langSwitcher.textContent = lang === 'es' ? 'EN' : 'ES';
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });

    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      const key = el.getAttribute('data-i18n-title');
      if (translations[lang][key]) {
        el.title = translations[lang][key];
      }
    });
    
    if(elements.courseSelect.options[0]) {
       elements.courseSelect.options[0].textContent = translations[currentLang].selectCourseDefault;
    }
  };

  const copyToClipboard = (text, button) => {
    if (!text || text === 'N/A') return;
    navigator.clipboard.writeText(text).then(() => {
      const originalContent = button.innerHTML;
      const originalTitle = button.title;
      button.innerHTML = `<i class="bi bi-check-lg"></i> ${translations[currentLang].copySuccessText}`;
      button.classList.add('btn-success');
      button.classList.remove('btn-outline-secondary');
      button.disabled = true;

      setTimeout(() => {
        button.innerHTML = originalContent;
        button.title = originalTitle;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
        button.disabled = false;
      }, 2000);
    }).catch(err => {
      console.error('Error al copiar al portapapeles', err);
      showNotification('No se pudo copiar el texto.', 'danger');
    });
  };

  const downloadCsv = (csvContent, filename) => {
    if (!csvContent) {
      showNotification(translations[currentLang].exportError, 'warning');
      return;
    }
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
  
  const populateCourses = (courses) => {
    elements.courseSelect.innerHTML = `<option value="">${translations[currentLang].selectCourseDefault}</option>`;
    if (courses && courses.length > 0) {
      courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.id;
        option.textContent = `${course.name} - ${course.section}`;
        option.dataset.courseName = course.name;
        option.dataset.teacherGroupEmail = course.teacherGroupEmail;
        option.dataset.courseGroupEmail = course.courseGroupEmail;
        elements.courseSelect.appendChild(option);
      });
    } else {
      showNotification(translations[currentLang].noCoursesFound, 'warning');
    }
    showLoader(false);
  };
  
  const populateUsers = (data) => {
    const usersCardBody = elements.usersSection.querySelector('.card-body');
    if (usersCardBody && !usersCardBody.querySelector('.owner-note')) {
        const note = document.createElement('p');
        note.className = 'form-text text-muted fst-italic owner-note';
        note.setAttribute('data-i18n', 'ownerIsAddedNote');
        note.textContent = translations[currentLang].ownerIsAddedNote;
        usersCardBody.insertBefore(note, usersCardBody.firstChild);
    }
    
    currentTeachers = data.teachers.map(t => t.email);

    const createUserCheckbox = (user, isSelectedByDefault) => {
      const isOwner = user.email === userInfo.email;
      let attributes = '';
      if (isOwner) {
        attributes = 'checked disabled';
      } else if (isSelectedByDefault) {
        attributes = 'checked';
      }
      return `
        <div class="form-check">
          <input class="form-check-input user-checkbox" type="checkbox" value="${user.email}" id="user-${user.id}" ${attributes}>
          <label class="form-check-label" for="user-${user.id}">${user.name} (${user.email})</label>
        </div>`;
    };

    elements.teachersList.innerHTML = data.teachers.map(user => createUserCheckbox(user, true)).join('');
    elements.studentsList.innerHTML = data.students.map(user => createUserCheckbox(user, true)).join('');
    
    elements.selectAllTeachers.checked = true;
    elements.selectAllStudents.checked = true;

    elements.usersSection.style.display = 'block';
    elements.groupCreationSection.style.display = 'block';
    showLoader(false);
  };

  const updateSelectAllStatus = (listContainer, masterCheckbox) => {
    const checkboxes = listContainer.querySelectorAll('.user-checkbox:not(:disabled)');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    masterCheckbox.checked = allChecked;
  };

  const handleSelectAll = (masterCheckbox, listContainer) => {
    const checkboxes = listContainer.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => {
      if (!cb.disabled) {
        cb.checked = masterCheckbox.checked
      }
    });
  };

  // --- EVENT LISTENERS ---

  elements.langSwitcher.addEventListener('click', () => {
    setLanguage(currentLang === 'es' ? 'en' : 'es');
  });

  elements.courseSelect.addEventListener('change', (e) => {
    const courseId = e.target.value;
    elements.usersSection.style.display = 'none';
    elements.groupCreationSection.style.display = 'none';
    elements.courseEmailsSection.style.display = 'none';

    if (courseId) {
      const selectedOption = e.target.options[e.target.selectedIndex];
      const teacherEmail = selectedOption.dataset.teacherGroupEmail;
      const courseEmail = selectedOption.dataset.courseGroupEmail;
      
      elements.teacherGroupEmailSpan.textContent = teacherEmail;
      elements.courseGroupEmailSpan.textContent = courseEmail;
      elements.courseEmailsSection.style.display = 'block';

      showLoader(true);
      google.script.run
        .withSuccessHandler(populateUsers)
        .withFailureHandler(err => {
          showNotification(`${translations[currentLang].userFetchError} ${err.message}`, 'danger');
          showLoader(false);
        })
        .obtenerUsuarios(courseId);
    }
  });
  
  elements.copyTeacherEmailBtn.addEventListener('click', (e) => {
    const textToCopy = elements.teacherGroupEmailSpan.textContent;
    copyToClipboard(textToCopy, e.currentTarget);
  });

  elements.copyCourseEmailBtn.addEventListener('click', (e) => {
    const textToCopy = elements.courseGroupEmailSpan.textContent;
    copyToClipboard(textToCopy, e.currentTarget);
  });

  elements.exportCoursesBtn.addEventListener('click', () => {
    showLoader(true);
    google.script.run
      .withSuccessHandler(csv => {
        downloadCsv(csv, 'classroom-courses.csv');
        showLoader(false);
      })
      .withFailureHandler(err => {
         showNotification(err.message, 'danger');
         showLoader(false);
      })
      .exportarCursosCsv();
  });

  elements.exportUsersBtn.addEventListener('click', () => {
     const courseId = elements.courseSelect.value;
     if (!courseId) return;
     showLoader(true);
     google.script.run
      .withSuccessHandler(csv => {
        downloadCsv(csv, `course-${courseId}-users.csv`);
        showLoader(false);
      })
      .withFailureHandler(err => {
         showNotification(err.message, 'danger');
         showLoader(false);
      })
      .exportarUsuariosCsv(courseId);
  });
  
  elements.teachersList.addEventListener('change', () => updateSelectAllStatus(elements.teachersList, elements.selectAllTeachers));
  elements.studentsList.addEventListener('change', () => updateSelectAllStatus(elements.studentsList, elements.selectAllStudents));
  elements.selectAllTeachers.addEventListener('change', () => handleSelectAll(elements.selectAllTeachers, elements.teachersList));
  elements.selectAllStudents.addEventListener('change', () => handleSelectAll(elements.selectAllStudents, elements.studentsList));

  elements.createGroupBtn.addEventListener('click', () => {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    if (selectedCheckboxes.length <= 2) {
      showModal(translations[currentLang].warningTitle, translations[currentLang].groupWithOnlyOwnerError);
      return;
    }

    const courseId = elements.courseSelect.value;
    const selectedOption = elements.courseSelect.options[elements.courseSelect.selectedIndex];
    const courseName = selectedOption.dataset.courseName;

    const selectedUsers = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    showLoader(true);
    const groupData = {
      courseId: courseId,
      courseName: courseName,
      members: selectedUsers,
      ownerEmail: userInfo.email,
      domain: userInfo.domain,
      makeVisible: elements.makeGroupVisibleCheck.checked,
      makeTeachersManagers: elements.makeTeachersManagersCheck.checked,
      allTeacherEmails: currentTeachers,
      restrictPostingToManagers: elements.restrictPostingCheck.checked
    };

    google.script.run
      .withSuccessHandler(response => {
        showLoader(false);
        if (response.success) {
          showNotification(translations[currentLang].groupCreateSuccess, 'success', response.groupEmail);
        } else {
          showNotification(response.message || translations[currentLang].groupCreateError, 'danger');
        }
      })
      .withFailureHandler(err => {
        showLoader(false);
        let finalMessage = translations[currentLang].groupCreateError;
        let emailForCopy = null;
        try {
          const jsonMatch = err.message.match(/\{.*\}/);
          if (jsonMatch) {
            const errorObj = JSON.parse(jsonMatch[0]);
            if (errorObj.key && translations[currentLang][errorObj.key]) {
              finalMessage = translations[currentLang][errorObj.key];
              if (errorObj.params) {
                for (const [paramKey, paramValue] of Object.entries(errorObj.params)) {
                  finalMessage = finalMessage.replace(`{{${paramKey}}}`, paramValue);
                }
                if (errorObj.params.groupEmail) {
                   emailForCopy = errorObj.params.groupEmail;
                }
              }
            } else {
               finalMessage += `: ${err.message}`;
            }
          } else {
             finalMessage += `: ${err.message}`;
          }
        } catch (e) {
           finalMessage += `: ${err.message}`;
        }
        showNotification(finalMessage, 'danger', emailForCopy);
      })
      .crearGrupoDeClase(groupData);
  });

  // --- INICIALIZACI칍N ---
  const initialize = () => {
    showLoader(true);

    const userLang = navigator.language || navigator.userLanguage; 
    const defaultLang = userLang.startsWith('es') ? 'es' : 'en';
    setLanguage(defaultLang);
    
    google.script.run
      .withSuccessHandler(info => {
        userInfo = info;
        google.script.run
          .withSuccessHandler(populateCourses)
          .withFailureHandler(err => {
            showNotification(`${translations[currentLang].courseFetchError}: ${err.message}`, 'danger');
            showLoader(false);
          })
          .obtenerCursos();
      })
      .withFailureHandler(err => {
        showNotification(`${translations[currentLang].userFetchFatalError}: ${err.message}`, 'danger');
        showLoader(false);
      })
      .obtenerInfoUsuario();
  };

  initialize();
});
</script>

